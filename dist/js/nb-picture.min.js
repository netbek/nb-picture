/*
 * nb-picture
 * https://github.com/netbek/nb-picture
 *
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){"use strict";b.module("nb.picture",["nb.i18n","nb.lodash","nb.picture.templates"])}(window,window.angular),function(a,b){"use strict";b.module("nb.picture").filter("join",function(){return function(a,b){return _.isArray(a)?a.join(_.isUndefined(b)?",":b):""}})}(window,window.angular),function(a,b){"use strict";function c(){var a={mediaqueries:{small:"only screen and (min-width: 0px)",medium:"only screen and (min-width: 640px)",large:"only screen and (min-width: 992px)",xlarge:"only screen and (min-width: 1440px)",xxlarge:"only screen and (min-width: 1920px)",landscape:"only screen and (orientation: landscape)",portrait:"only screen and (orientation: portrait)",retina:"only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx)"}};return{set:function(b){a=b},$get:function(){return a}}}b.module("nb.picture").provider("nbPictureConfig",c)}(window,window.angular),function(a,b,c){"use strict";function d(b,d,f,g,h,i,j){function k(a){var b=a.readyState;return!a.src&&!a.srcset||!a.complete&&"complete"!=b&&"loaded"!=b&&4!=b?!1:!0}function l(){(w.src||w.srcset)&&(b.complete=!0,o(),y.push(g(function(){b.map.$show=!1,b.$apply()})))}function m(){k(w)&&(b.complete=!0,o(),(b.map.highlight.enable||b.map.resize)&&y.push(g(function(){s(b.map),b.map.highlight.enable&&b.map.highlight.alwaysOn&&(b.highlights=_.cloneDeep(b.map.areas),b.$broadcast("nbPicture:draw")),b.map.$show=!0,b.$apply()})))}function n(){v.on("error",l),v.on("load",m),v.on("readystatechange",m)}function o(){v.off("error",l),v.off("load",m),v.off("readystatechange",m)}function p(){if(b.map.resize&&s(b.map),b.map.highlight.enable&&b.highlights.length){var a=_.pluck(b.highlights,"$id"),c=[];_.forEach(a,function(a){var d=_.find(b.map.areas,{$id:a});d&&c.push(_.cloneDeep(d))}),b.highlights=c,b.$broadcast("nbPicture:draw")}b.$apply()}function q(){a.addEventListener?a.addEventListener("resize",p,!1):a.attachEvent&&a.attachEvent("onresize",p)}function r(){a.removeEventListener?a.removeEventListener("resize",p,!1):a.detachEvent&&a.detachEvent("onresize",p)}function s(a){if(a.relCoords){var c=b.width(),d=b.height();_.forEach(a.areas,function(a){var b,e=a.shape.toLowerCase(),f=a.coords,g=f.length,h=new Array(g);if("circle"===e)for(b=0;g>b&&3>b;b++)2>b&&(h[b]=Math.round(f[b]*(b%2===0?c:d)));else if("poly"===e)for(b=0;g>b;b++)h[b]=Math.round(f[b]*(b%2===0?c:d));else if("rect"===e)for(b=0;g>b&&4>b;b++)h[b]=Math.round(f[b]*(b%2===0?c:d));a.$coords=h})}return a}function t(a){return{$id:a.id,$coords:_.map(a.coords.split(","),u),shape:a.shape}}function u(a){return Number(a)}var v,w,x={init:!1},y=[],z={name:c,areas:[],resize:!1,relCoords:!1,highlight:{enable:!1,fill:!0,fillColor:"FF0000",fillOpacity:.5,alwaysOn:!1},$show:!1};b.complete=!1,b.map=_.cloneDeep(z),b.highlights=[],b.showHighlight=function(a){var c=_.findIndex(b.highlights,{$id:a.target.id});0>c&&(b.highlights.push(t(a.target)),b.$broadcast("nbPicture:draw"))},b.hideHighlight=function(a){if(!b.map.highlight.alwaysOn){var c=_.findIndex(b.highlights,{$id:a.target.id});c>=0&&(b.highlights.splice(c,1),b.$broadcast("nbPicture:draw"))}},b.width=function(){return b.complete&&w?w.scrollWidth:0},b.height=function(){return b.complete&&w?w.scrollHeight:0},this.attrs=function(){return{alt:f.alt,defaultSource:f.defaultSource,sources:f.sources,map:f.map}},this.init=function(){x.init||(x.init=!0,v=d.find("img"),w=v[0])},this.destroy=function(){_.forEach(y,function(a){g.cancel(a)}),r(),v&&o(),b.highlights=[]},this.update=function(a){if(x.init){this.destroy(),b.complete=!1,n();var f;if(!_.isUndefined(a.map)&&a.map.length){var k=b.$eval(a.map);if(!_.isObject(k))throw new Error(h.t('Excepted attribute "!attribute" to evaluate to !type',{"!attribute":"map","!type":"Object"}));f=_.extend({},z,k),f.name=f.name||"nb-picture-map-"+ ++e,_.forEach(f.areas,function(a){a.$id="nb-picture-map-area-"+ ++e,a.$coords=_.cloneDeep(a.coords)})}else f=_.cloneDeep(z);var l={sources:[],img:{}},m=b.$eval(a.sources);if(!_.isArray(m))throw new Error(h.t('Excepted attribute "!attribute" to evaluate to !type',{"!attribute":"sources","!type":"Array"}));for(var o=m.length,p=o-1;p>=0;p--){var r,s=m[p];!_.isUndefined(s[1])&&s[1]in i.mediaqueries&&(r=i.mediaqueries[s[1]]),l.sources.push({srcset:s[0],media:r})}l.sources.push({srcset:a.defaultSource}),l.img={srcset:a.defaultSource,alt:a.alt,usemap:!f.resize&&f.name?"#"+f.name:c},f.img={src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",alt:a.alt,usemap:f.name?"#"+f.name:c},b.map=f,b.picture=l,y.push(g(function(){j(d),q()}))}}}b.module("nb.picture").controller("nbPictureController",d);var e=0;d.$inject=["$scope","$element","$attrs","$timeout","nbI18N","nbPictureConfig","picturefill"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,controller:"nbPictureController",templateUrl:"templates/nb-picture.html",link:function(a,b,c,d){d.init();var e=a.$watch(d.attrs,function(a){d.update(a)},!0);a.$on("$destroy",function(){e(),d.destroy()})}}}b.module("nb.picture").directive("nbPicture",c)}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,controller:"nbPictureController",templateUrl:"templates/nb-picture-once.html",link:function(a,b,c,d){d.init();var e=a.$watch(d.attrs,function(a){d.update(a),e()},!0);a.$on("$destroy",function(){e(),d.destroy()})}}}b.module("nb.picture").directive("nbPictureOnce",c)}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,templateUrl:"templates/nb-picture-resize.html",link:function(){}}}b.module("nb.picture").directive("nbPictureResize",c)}(window,window.angular),function(a,b){"use strict";function c(a,b){function c(){i.init&&(k.areas=[],h.clearRect(0,0,g.width,g.height))}function d(b){if(i.init&&(k.areas=b,g.width=g.scrollWidth,g.height=g.scrollHeight,b.length)){var c=a.map.highlight;c.fill&&(h.fillStyle=f(c.fillColor,c.fillOpacity)),_.forEach(b,function(a){var b=a.shape,c=a.$coords;if("circle"===b);else if("poly"===b);else if("rect"===b){var d=c[0],e=c[1],f=c[2]-c[0],g=c[3]-c[1];h.fillRect(d,e,f,g)}})}}function e(a){return Math.max(0,Math.min(parseInt(a,16),255))}function f(a,b){return"rgba("+e(a.slice(0,2))+","+e(a.slice(2,4))+","+e(a.slice(4,6))+","+b+")"}var g,h,i={init:!1,resize:!1},j=[],k={areas:[]};this.init=function(){i.init||(i.init=!0,g=b[0],h=g.getContext("2d"),d(a.highlights),j.push(a.$on("nbPicture:draw",function(){a.highlights.length?d(a.highlights):c()})))},this.destroy=function(){_.forEach(j,function(a){a()})}}b.module("nb.picture").controller("nbPictureResizeCanvasController",c),c.$inject=["$scope","$element","$attrs","$timeout"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,controller:"nbPictureResizeCanvasController",templateUrl:"templates/nb-picture-resize-canvas.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.picture").directive("nbPictureResizeCanvas",c)}(window,window.angular),function(a,b){"use strict";function c(a){return a.picturefill}b.module("nb.picture").factory("picturefill",c),c.$inject=["$window"]}(window,window.angular),angular.module("nb.picture.templates",["templates/nb-picture-bindonce.html","templates/nb-picture-once.html","templates/nb-picture-resize-canvas.html","templates/nb-picture-resize.html","templates/nb-picture.html"]),angular.module("templates/nb-picture-bindonce.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-bindonce.html",'<span>\n	<picture>\n		<!--[if IE 9]><video style="display: none;"><![endif]-->\n		<source ng-repeat="source in picture.sources"\n				bindonce="source"\n				bo-attr\n				bo-attr-srcset="source.srcset"\n				bo-attr-media="source.media" />\n		<!--[if IE 9]></video><![endif]-->\n		<img bindonce="picture.img"\n			 bo-attr\n			 bo-attr-srcset="img.srcset"\n			 bo-attr-alt="img.alt"\n			 bo-attr-usemap="img.usemap" />\n	</picture>\n</span>')}]),angular.module("templates/nb-picture-once.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-once.html",'<span class="picture">\n	<map ng-if="::map.areas"\n		 ng-attr-name="{{::map.name}}">\n		<area ng-repeat="area in ::map.areas track by area.$id"\n			  ng-attr-id="{{::area.$id}}"\n			  ng-attr-shape="{{::area.shape}}"\n			  ng-attr-coords="{{area.$coords | join:\',\'}}"\n			  ng-href="{{::area.href}}"\n			  ng-attr-alt="{{::area.alt}}"\n			  ng-attr-title="{{::area.title}}"\n			  ng-focus="showHighlight($event);"\n			  ng-mouseenter="showHighlight($event);"\n			  ng-blur="hideHighlight($event);"\n			  ng-mouseleave="hideHighlight($event);" />\n	</map>\n	<picture>\n		<!--[if IE 9]><video style="display: none;"><![endif]-->\n		<source ng-repeat="source in ::picture.sources"\n				ng-srcset="{{::source.srcset}}"\n				ng-attr-media="{{::source.media}}" />\n		<!--[if IE 9]></video><![endif]-->\n		<img ng-srcset="{{::picture.img.srcset}}"\n			 ng-attr-alt="{{::picture.img.alt}}"\n			 ng-attr-usemap="{{::picture.img.usemap}}" />\n	</picture>\n	<span nb-picture-resize\n		  ng-if="map.$show && (map.highlight.enable || map.resize)"></span>\n</span>')}]),angular.module("templates/nb-picture-resize-canvas.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-resize-canvas.html","<canvas></canvas>\n")}]),angular.module("templates/nb-picture-resize.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-resize.html",'<span class="picture-resize">\n	<span nb-picture-resize-canvas></span>\n	<img ng-src="{{map.img.src}}"\n		 ng-attr-alt="{{map.img.alt}}"\n		 ng-attr-usemap="{{map.img.usemap}}" />\n</span>')}]),angular.module("templates/nb-picture.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture.html",'<span class="picture">\n	<map ng-if="map.areas"\n		 ng-attr-name="{{map.name}}">\n		<area ng-repeat="area in map.areas track by area.$id"\n			  ng-attr-id="{{area.$id}}"\n			  ng-attr-shape="{{area.shape}}"\n			  ng-attr-coords="{{area.$coords | join:\',\'}}"\n			  ng-href="{{area.href}}"\n			  ng-attr-alt="{{area.alt}}"\n			  ng-attr-title="{{area.title}}"\n			  ng-focus="showHighlight($event);"\n			  ng-mouseenter="showHighlight($event);"\n			  ng-blur="hideHighlight($event);"\n			  ng-mouseleave="hideHighlight($event);" />\n	</map>\n	<picture>\n		<!--[if IE 9]><video style="display: none;"><![endif]-->\n		<source ng-repeat="source in picture.sources"\n				ng-srcset="{{source.srcset}}"\n				ng-attr-media="{{source.media}}" />\n		<!--[if IE 9]></video><![endif]-->\n		<img ng-srcset="{{picture.img.srcset}}"\n			 ng-attr-alt="{{picture.img.alt}}"\n			 ng-attr-usemap="{{picture.img.usemap}}" />\n	</picture>\n	<span nb-picture-resize\n		  ng-if="map.$show && (map.highlight.enable || map.resize)"></span>\n</span>')}]);